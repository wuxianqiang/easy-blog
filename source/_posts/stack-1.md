---
title: 堆内存和栈内存
date: 2019-11-15 07:39:30
tags: JavaScript
---

{% asset_img banner.png 图片 %}

引擎是编译和执行代码的程序，Google V8 引擎使用 C++ 代码编写，实现了 ECMAScript 规范。那么引擎是如何分配和管理内存的呢？


<!-- more -->

{% asset_img v8.jpg 图片 %}

handle 是指向对象的指针，在 V8 中，所有的对象都通过 handle 来引用，handle 主要用于 V8 的垃圾回收机制。



垃圾收集器在运行的时候会给存储在内存中的所有变量都加上标记。然后，它会去掉环境中的变量以及被环境中的变量引用的变量的标记。而在此之后再被加上标记的变量将被视为准备删除的变量，原因是环境中的变量已经无法访问到这些变量了。最后，垃圾收集器完成内存清除工作，销毁那些带标记的值并回收它们所占用的内存空间。



栈区（stack）— 由编译器自动分配释放 ，存放函数的参数值，局部变量的值等。其操作方式类似于数据结构中的栈。


```js
function fn () {
  let a = { }
  console.log(a) // 可以访问
}
fn()
console.log(a) // 无法访问
```


每个函数都有自己的执行环境。当执行流进入一个函数时，函数的环境就会被推入一个环境栈中。而在函数执行之后，栈将其环境弹出，把控制权返回给之前的执行环境。ECMAScript程序中的执行流正是由这个方便的机制控制着。



某个执行环境中的所有代码执行完毕后，该环境被销毁，保存在其中的所有变量和函数定义也随之销毁。


{% asset_img handle.png 图片 %}



堆区（heap） — 堆中存放的都是实体（对象），实体用于封装数据（实体的多个属性），如果一个数据消失，这个实体也没有消失，还可以用，所以堆是不会随时释放的，但是栈不一样，栈里存放的都是单个变量，变量被释放了，那就没有了。堆里的实体虽然不会被释放，但是会被当成垃圾，Javascript有垃圾回收机制不定时的收取。
